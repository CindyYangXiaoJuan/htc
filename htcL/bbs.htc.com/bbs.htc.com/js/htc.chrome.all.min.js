var popOver = (function() {
    'use strict';

    var popOver = {
        closeAll: function() {
            $('.popover').removeClass('active');
        }
    };

    return popOver;
}());

var header = (function() {
    'use strict';

    var header = {
		scrollIntervalID: null,
        setupMobileNavigation: function() {
            $('.m-header .has-sub-menu .title').on('click', function(event) {
                event.preventDefault();
                if ($(this).parent().hasClass('expanded')) {
                    $(this).parent().toggleClass('expanded');
                } else {
                    $('.m-header .main-navi-block li').removeClass('expanded');
                    $(this).parent().toggleClass('expanded');
                }
            });
        },
        setupMobileSubMenuClick: function() {
            $('.has-third-menu').on('click', function(event) {
                event.preventDefault();
                $(this).toggleClass('expanded');
                $(this).next('.third-menu').toggleClass('expanded');
            });
        },
        setupDesktopMainNavigation: function() {
            var animated = false,
                timer,
                sleep;

            $('.d-header .menu-list').on('mouseleave', function(event) {
                event.preventDefault();
                animated = false;
            });

            $('.d-header .no-sub-menu').on('mouseenter', function(event) {
                event.preventDefault();
                animated = false;
            });

            $('.d-header .has-sub-menu').on('mouseenter', function(event) {
                event.preventDefault();
                sleep = 1;
                var ob = $(this);

                if (!animated) {
                    timer = setTimeout(function() {
                        if (sleep) {
                            ob.parent().addClass('animated');
                            ob.parent().find('li').removeClass('expanded');
                            ob.toggleClass('expanded');
                            animated = true;
                        }
                    }, 300);
                } else {
                    ob.parent().removeClass('animated');
                    ob.parent().find('li').removeClass('expanded');
                    ob.toggleClass('expanded');
                }
            });

            $('.d-header .has-sub-menu').on('mouseleave', function(event) {
                event.preventDefault();
                sleep = 0;
                clearTimeout(timer);
                $(this).removeClass('expanded');
                $(this).parent().removeClass('animated');
            });

            $('.d-header .has-sub-menu .title').on('touchstart', function(event) {
                if (!$('html').hasClass('desktop')) {
                    event.preventDefault();
                    var ob = $(this).parent();
                    if (ob.hasClass('expanded')) {
                        ob.removeClass('expanded');
                        ob.parent().removeClass('animated');
                    } else {
                        ob.parent().find('li').removeClass('expanded');
                        ob.toggleClass('expanded');
                    }
                }
            });
        },
        setupDesktopStickyHeader: function() {
            //console.log('setupDesktopStickyHeader');
            /*var desktopHeaderObj = $('.d-header'),
                htcHeaderObj = $('.htc-header');*/

            header.scrollIntervalID = setInterval(stickIt, 10);

            function stickIt() {
                //console.log($(window).scrollTop() + ' = ' + $('.d-header').height());
                if ($('html').hasClass('desktop') && $('.htc-header').is(':visible') && $('.d-header').is(':visible')) {
                    if ($(window).scrollTop() >= $('.d-header').height() / 3 && $(window).width() > HtcChrome.mobileMaxWidth) {
                        //desktopHeaderObj.addClass('sticky');
                        $('header').addClass('sticky');
                    } else {
                        //desktopHeaderObj.removeClass('sticky');
                        $('header').removeClass('sticky');
                    }
                }
            }
        },
		removeStickyInterval: function(){
			clearInterval(header.scrollIntervalID);
			//console.log('removeSticky');
		},
        setupSignupPopover: function() {
            var signupPopover = $('.signup-popover');
            if (signupPopover.length > 0) {
                var timer,
                    sleep;
                $('.top-item.signup').on('mouseenter', function(event) {
                    event.preventDefault();
                    sleep = 1;
                    timer = setTimeout(function() {
                        if (sleep) {
                            if (!signupPopover.hasClass('active')) {
                                popOver.closeAll();
                                signupPopover.addClass('active');
                            }
                        }
                    }, 200);
                });
                $('.top-item.signup').on('mouseleave', function(event) {
                    event.preventDefault();
                    sleep = 0;
                    clearTimeout(timer);
                    signupPopover.removeClass('active');
                });
                if (!$('html').hasClass('desktop')) {
                    $('.top-item.signup .top-title').on('touchstart', function(event) {
                        event.preventDefault();
                        signupPopover.toggleClass('active');
                    });
                }
            }
        },
        setupSignupYNbutton: function() {
            $('.YN-wrapper').on('click', '.Y, .N', function(event) {
                event.preventDefault();
                /* Act on the event */
                $('.btnYN').removeClass('active');
                $(this).addClass('active');
                //trigger ownedHtc radio button
                $("#ownedHtc").prop("checked", true);
                $('#HtcSignup').valid();
            });
        },
        setupSignupDropdown: function() {
            var ddm = $('#HtcSignup .custom-selector.carrier-selector'),
                dropper = ddm.find('.dropper'),
                downer = ddm.find('.downer'),
                downeritem = ddm.find('.downer ul li');

            dropper.click(function() {
                $('.downer').toggleClass('show');
            });

            downeritem.click(function(e) {
                downer.removeClass('show');
                ddm.find('.downer ul li').removeClass('selected');
                $(this).addClass('selected');
                var itemText = $(this).find('.select-item-text').text(),
                    itemvalue = $(this).data('value');
                dropper.find('.select-item-text').text(itemText);
                dropper.attr('data-value', itemvalue);
                dropper.addClass('selected');

            });

            ddm.bind('mouseover', function() {
                downer.addClass('show');
            });
            ddm.bind('mouseout', function() {
                downer.removeClass('show');
            });
        },
        setupSearchQueryPlaceholderForIE: function() {
            /*IE9 placeholder*/
            if ($('html').hasClass('no-csstransforms3d')) {
                $('#HtcSearchForm').find('.query').placeholder();
            }
        },
        setupSearchFormSubmit: function() {
            $('#HtcSearchForm').on('submit', function(event) {
                if ($(this).find('.query').val() === '') {
                    return false;
                }
            });
        }

    };

    return header;

}());

var footer = (function() {
    'use strict';

    var footer = {
        hideArrow: function() {
            $('.arrow-block').hide();
        },
        resetArrowDown: function() {
            $('.arrow-block').removeClass('arrow-up');
            $('footer').removeClass('expanded');
            $('footer .footer-list').removeClass('expanded');
        },
        setupArrowClick: function() {
            $('.arrow-block').on('click', function(event) {
                event.preventDefault();
                footer.ArrowClicked();
            });
        },
        ArrowClicked: function() {
            popOver.closeAll();
            var arrowObj = $('.arrow-block'),
                footerObj = $('footer'),
                footerList = footerObj.find('.footer-list');
            //console.log($(document).height());
            if (!footerList.hasClass('expanded')) {
                footerList.stop().fadeIn(100, function() {
                    //console.log($(document).height());
                    //console.log($('footer').offset().top);
                    $('html, body').stop().animate({
                        scrollTop: $(document).height()
                    }, 800);
                });
            } else {
                footer.hideFooterList();
            }
            arrowObj.toggleClass('arrow-up');
            footerList.toggleClass('expanded');
        },
        hideFooterList: function() {
            var arrowObj = $(this),
                footerObj = $('footer'),
                footerList = footerObj.find('.footer-list');
            if (footerList.hasClass('expanded')) {
                footerList.hide();
            }
        },
        setupConnectPopover: function() {
            $('.connect-block').on('click', function(event) {
                event.preventDefault();
                footer.hideFooterList();
                if (!$('.connect-popover').hasClass('active')) {
                    popOver.closeAll();
                    footer.resetArrowDown();
                    $('.connect-popover').addClass('active');
                } else {
                    $('.connect-popover').removeClass('active');
                }
            });
        },
        setupRegionPopover: function() {
            $('.region-block').on('click', function(event) {
                event.preventDefault();
                footer.hideFooterList();
                if (!$('.region-popover').hasClass('active')) {
                    popOver.closeAll();
                    footer.resetArrowDown();
                    $('.region-popover').addClass('active');
                } else {
                    $('.region-popover').removeClass('active');
                }
            });
            $('.region-popover .list-closer').on('click', function(event) {
                event.preventDefault();
                $('.region-popover').removeClass('active');
            });
        },
        showDeepBottom: function(iHeight, bgColor) {
            $('.deep-bottom').addClass('show');
            if (iHeight !== undefined) {
                $('.deep-bottom').css("height", iHeight);
            }
            if (bgColor !== undefined) {
                $('.deep-bottom').css("background-color", bgColor);
            }
        }
    };

    return footer;

}());

var signup = (function() {
    'use strict';

    var signupInterval;
    var signup = {
        init: function() {
            signup.setupValidateion();

            /*IE9 placeholder*/
            if ($('html').hasClass('no-csstransforms3d')) {
                $('#HtcSignup').find('.input-text').placeholder();
            }

            $('#HtcSignup input[type="submit"]').on('click', function(event) {
                event.preventDefault();
                if ($('#HtcSignup').valid() === false) {
                    return false;
                } else {
                    signup.sendSubscription();
                    signup.showThankyou();
                }
            });
        },
        timerClose: function() {
            if ($('.signup-popover').hasClass('active')) {
                $('.signup-popover').removeClass('active');
            } else {
                clearInterval(signupInterval);
            }
        },
        showThankyou: function() {
            $('.form-block').hide();
            $('.thank-you-wrapper').show();
            $('.thank-you-wrapper .signup-closer').on('click', function(event) {
                event.preventDefault();
                $('.signup-popover').removeClass('active');
            });
            //Setup auto close
            signupInterval = setInterval(function() {
                signup.timerClose();
            }, 3000);
        },
        setupValidateion: function() {
            if ($.validator === undefined) {
                return true;
            }
            $.validator.addMethod('specialchars', function(value, element) {
                var key = value;
                var regex = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
                if (!regex.test(key)) {
                    return false;
                }
                return true;
            });

            $('#HtcSignup').validate({
                errorClass: 'error',
                errorElement: 'div',
                invalidHandler: function(e, validator) {},
                errorPlacement: function(error, element) {
                    switch ($(element).attr('name')) {
                        case 'ownedHtc':
                            error.insertAfter($('.question-wrapper'));
                            break;
                        default:
                            error.insertAfter(element);
                            break;
                    }
                },
                debug: true
            });
        },
        sendSubscription: function() {
            //console.log('sendSubscription');
            var padZero = function(n) {
                return n < 10 ? '0' + n : n;
            };

            var appID = 'htc-newsletter',
                campaignID = 'newsletter',
                campaignCTA = "header",
                servicePath = 'https://ws.htc.com/htc-subscription-1.6',
                urlStr = servicePath + '/profile?callback=?',
                path = window.location.pathname.split('/'),
                defaultCountrySite = 'us',
                countrySite = defaultCountrySite,
                defaultLanguage = 'en',
                language = defaultLanguage,
                locale = window.navigator.language,
                carrierSelection = $('#HtcSignup .custom-selector.carrier-selector .dropper'),
                carrierValue = '',
                emailValue = $('#HtcSignup #emailtext').val(),
                emailMe = $('#HtcSignup #chxEmailMe').is(':checked'),
                ownHtcProduct = $('#HtcSignup .btnYN.Y');

            if (locale !== undefined && locale !== null) {
                var localeParts = locale.split('_'); //e.g. en_US
                language = localeParts[0];
            }

            if (typeof countrySiteOverride !== 'undefined' && countrySiteOverride.length > 0) {
                countrySite = countrySiteOverride;
            } else {
                countrySite = path[1];
                var countrySiteParts = countrySite.split('-');

                if (countrySiteParts[1] !== undefined && countrySiteParts[1].length > 0) {
                    countrySite = countrySiteParts[0];
                    language = countrySiteParts[1]; //get language via URI path
                }
            }

            if (carrierSelection.hasClass('selected')) {
                carrierValue = carrierSelection.data('value');
            }
            //console.log('carrierValue=' + carrierValue);

            if (language === undefined || language === '') {
                language = defaultLanguage;
            }

            var newsletterSubscriptionType = 'prospect';
            if (ownHtcProduct.hasClass('active')) {
                newsletterSubscriptionType = 'customer';
            }

            var now = new Date();
            var ISO8601DateTimestamp = now.getUTCFullYear() + '-' +
                padZero(now.getUTCMonth() + 1) + '-' +
                padZero(now.getUTCDate()) + 'T' +
                padZero(now.getUTCHours()) + ':' +
                padZero(now.getUTCMinutes()) + ':' +
                padZero(now.getUTCSeconds()) + '-00:00';

            var formData = {
                app_id: appID,
                email: emailValue,
                lang: language,
                zip: '',
                country: countrySite,
                ip: '0.0.0.0',
                date: ISO8601DateTimestamp,
                s_type: newsletterSubscriptionType,
                s_agreement: 'true',
                s_welcome: 'true',
                s_newsletter: emailMe,
                s_product: 'false',
                r_url: window.location.href,
                r_campaign: campaignID,
                r_cta: campaignCTA,
                r_pid: '',
                r_pname: '',
                ws_echo: 'false',
                'misc[carrier]': carrierValue
            };

            $.ajax({
                type: 'GET',
                url: urlStr,
                data: formData,
                dataType: 'json',
                jsonp: true,
                async: true,
                beforeSend: function(evt) {
                    //console.log('beforeSend');
                },
                success: function(data) {
                    //console.log('success');
                    if (data.status === 'success') {
                        try {
                            s.linkTrackEvents = 'event1,event17';
                            s.linkTrackVars = 'prop47,eVar17,events';
                            s.events = 'event1,event17';
                            s.eVar17 = 'Registered Users';
                            s.prop47 = 'Newsletter: Registration Success';
                            s.tl(this, 'o', 'Registration Success Newsletter Signup Form');
                        } catch (err) {}
                    } else {
                        if (data.status === 'failed') {
                            try {
                                s.linkTrackVars = 'prop47,events';
                                s.linkTrackEvents = 'event1';
                                s.events = 'event1';
                                s.prop47 = 'Newsletter: Failed Signup';
                                s.tl(this, 'o', 'Failed Signup Newsletter Signup Form');
                            } catch (err) {}
                        }
                    }
                },
                error: function(data) {
                    //console.log('error');
                    try {
                        s.linkTrackVars = 'prop47,events';
                        s.linkTrackEvents = 'event1';
                        s.events = 'event1';
                        s.prop47 = 'Newsletter: Failed Signup';
                        s.tl(this, 'o', 'Failed Signup Newsletter Signup Form');
                    } catch (err) {}
                }
            });


        }
    };

    return signup;

}());

var shoppingCart = (function() {
    'use strict';

    var shoppingCart = {
        cartItemTemplate: "",
        init: function() {
            //console.log('init');
            shoppingCart.cartItemTemplate = $('.cart-popover').find('.prod-item');
            shoppingCart.updateCartStatus();
        },
        showCartZero: function() {
            //No items in cart
            var cartPopoverTemplate = $('.cart-popover');
            cartPopoverTemplate.removeClass('enable-popover');
            cartPopoverTemplate.removeClass('active');
            // zero item count
            $('.cartCount').text('0');
            shoppingCart.unbindCartPopover();
        },
        updateCartStatus: function() {
            //console.log('updateCartStatus');
            try {
                //Required API
                var cartAPI = new CartProvider(),
                    cartPopoverTemplate = $('.cart-popover'),
                    producListBlock = cartPopoverTemplate.find('.prod-list'),
                    checkoutButton = cartPopoverTemplate.find('.checkout'),
                    subtotalLabel = cartPopoverTemplate.find('.subtotal-amt'),
                    mobileCartCheckout = $('.m-header .cart-tab .checkout');

                if (typeof cartAPI !== 'undefined') {
                    cartAPI.getCart(function(cart) {
                        //console.log(cart);
                        if (cart.items && cart.items.length > 0) {
                            //Add quantity to cart
                            $('.cartCount').text(cart.totalItems);

                            //Setup desktop cart list
                            producListBlock.empty();

                            $.each(cart.items, function(index, val) {
                                var obj = $(this),
                                    thumbnailImage = obj[0].image,
                                    quantity = obj[0].quantity,
                                    displayName = obj[0].name,
                                    id = obj[0].id,
                                    price = obj[0].price,
                                    itemTemplate = shoppingCart.cartItemTemplate.clone();

                                itemTemplate.find('.prod-name').text(displayName);
                                itemTemplate.find('.prod-quantity').text('(' + quantity + ')');
                                itemTemplate.find('.prod-price').text(price);
                                itemTemplate.find('.prod-img img').attr('src', thumbnailImage);
                                itemTemplate.attr('data-id', id);

                                producListBlock.append(itemTemplate);

                            });

                            //delete button
                            producListBlock.find('.prod-delete').on('click', function(event) {
                                event.preventDefault();
                                /* Act on the event */
                                var deletedRow = $(this).closest('.prod-item'),
                                    id = deletedRow.data('id');

                                cartAPI.removeItemFromCart(id, function() {
                                    deletedRow.remove();
                                    shoppingCart.updateCartStatus();
                                });
                            });

                            //checkout button
                            checkoutButton.on('click', function(event) {
                                event.preventDefault();
                                cartAPI.checkout();
                            });

                            //Setup mobile header checkout button
                            mobileCartCheckout.on('click', function(event) {
                                event.preventDefault();
                                cartAPI.checkout();
                            });

                            //Setup subtotal
                            subtotalLabel.html(cart.subTotal);

                            //Enable popover
                            $('.cart-popover').addClass('enable-popover');
                            //if (header !== null && typeof header !== 'undefined') {
                            shoppingCart.setupCartPopover();
                            //}

                        } else {
                            shoppingCart.showCartZero();
                        }
                    });
                } else {
                    shoppingCart.showCartZero();
                }
            } catch (err) {
                shoppingCart.showCartZero();
            }

        },
        setupCartPopover: function() {
            var desktopHeader = $('.d-header'),
                cartPopover = desktopHeader.find('.cart-popover'),
                cartTopItem = desktopHeader.find('.top-item.cart'),
                cartTitleItem = desktopHeader.find('.top-item.cart > .top-title');

            if (cartPopover !== null && cartPopover.length > 0 && cartPopover.hasClass('enable-popover')) {
                var timer,
                    sleep;
                cartTopItem.on('mouseenter', function(event) {
                    event.preventDefault();
                    sleep = 1;
                    timer = setTimeout(function() {
                        if (sleep) {
                            if (!cartPopover.hasClass('active')) {
                                popOver.closeAll();
                                cartPopover.addClass('active');
                                //console.log('mouseenter');
                            }
                        }
                    }, 200);
                });
                cartTopItem.on('mouseleave', function(event) {
                    event.preventDefault();
                    sleep = 0;
                    clearTimeout(timer);
                    cartPopover.removeClass('active');
                    //console.log('mouseleave');
                });
                if (!$('html').hasClass('desktop')) {
                    cartTitleItem.on('touchstart', function(event) {
                        event.stopImmediatePropagation();
                        event.preventDefault();
                        cartPopover.toggleClass('active');
                    });
                }

                //console.log('setupCartPopover OK');
            }
        },
        unbindCartPopover: function() {
            var desktopHeader = $('.d-header'),
                cartPopover = desktopHeader.find('.cart-popover'),
                cartTopItem = desktopHeader.find('.top-item.cart'),
                cartTitleItem = desktopHeader.find('.top-item.cart > .top-title');
            cartTopItem.unbind('mouseenter mouseleave');
            cartTitleItem.unbind('touchstart');
            //console.log('unbindCartPopover OK');
        }
    };

    return shoppingCart;

}());

var HtcChrome = (function() {
    'use strict';
    // chrome interactions
    var HtcChrome = {
        init: function() {
            header.setupMobileNavigation();
            header.setupMobileSubMenuClick();
            header.setupDesktopMainNavigation();
            header.setupDesktopStickyHeader();
            footer.setupArrowClick();
            footer.setupConnectPopover();
            footer.setupRegionPopover();
            header.setupSearchFormSubmit();
            header.setupSearchQueryPlaceholderForIE();

            if ($('.htc-chrome').find('.top-navi-block li.signup').length > 0) {
                //console.log('test');
                header.setupSignupPopover();
                header.setupSignupYNbutton();
                header.setupSignupDropdown();
                signup.init();
            }

            if ($('.htc-chrome').find('.top-navi-block li.cart').length > 0) {
                shoppingCart.init();
            }

            HtcChrome.setHeaderFooterButton();
        },
        setHeaderFooterButton: function() {
            if ($('.header-button') !== undefined) {
                $('.header-button').unbind('click').click(function() {
                    HtcChrome.showHeader(true, true);
                });
            }

            if ($('.footer-button') !== undefined) {
                $('.footer-button').unbind('click').click(function() {
                    HtcChrome.showFooter(true, true);
                });
            }

            $('.chrome-overlay').click(function() {
                if ($('.header-button').html() !== undefined) {
                    HtcChrome.hideHeader(true);
                }
                if ($('.footer-button').html() !== undefined) {
                    HtcChrome.hideFooter(true, true);
                }

            });
        },
        hideHeader: function(overlay, useButton) {
            overlay = typeof overlay !== 'undefined' ? overlay : false;
            useButton = typeof useButton !== 'undefined' ? useButton : false;
            var headerHeight = '-' + $('#htc-header').height() + 'px';
            $('#htc-header').animate({
                top: headerHeight,
                opacity: 0.7
            }, 300);
            $('#htc-header').hide();
            if (overlay) {
                $('.chrome-overlay').fadeOut(300);
            }
        },
        hideFooter: function(overlay, useButton) {
            overlay = typeof overlay !== 'undefined' ? overlay : false;
            useButton = typeof useButton !== 'undefined' ? useButton : false;
            var footerHeight = '-' + $('#htc-footer').height() + 'px';
            //$('#htc-footer').css('bottom', footerHeight);
            $('#htc-footer').animate({
                bottom: footerHeight,
                opacity: 0.7
            }, 300);
            //$('.footer-button').attr('data-position', footerHeight);
            $('#htc-footer').hide();
            var footerList = $('#htc-footer').find('.footer-list');
            if (footerList.hasClass('expanded')) {
                footerList.removeClass('expanded');
                footerList.css('display', 'none');
            }
            if (overlay) {
                $('.chrome-overlay').fadeOut(300);
            }
        },
        showHeader: function(overlay, useButton) {
            overlay = typeof overlay !== 'undefined' ? overlay : false;
            useButton = typeof useButton !== 'undefined' ? useButton : false;
            $('#htc-header').show();
            $('#htc-header').animate({
                top: 0,
                opacity: 1
            }, 300);
            if (overlay) {
                $('.chrome-overlay').fadeIn(300);
            }
        },
        showFooter: function(overlay, useButton) {
            overlay = typeof overlay !== 'undefined' ? overlay : false;
            useButton = typeof useButton !== 'undefined' ? useButton : false;
            if (useButton) {
                footer.hideArrow();
                footer.ArrowClicked();
            }
            $('#htc-footer').show();
            $('#htc-footer').animate({
                bottom: 0,
                opacity: 1
            }, 300);
            if (overlay) {
                $('.chrome-overlay').fadeIn(300);
            }
        },
        showDeepBottom: function(iHeight, bgColor) {
            footer.showDeepBottom(iHeight, bgColor);
        },
        mobileMaxWidth: 720

    };



    return HtcChrome;

}());



$(document).ready(function($) {
    'use strict';
    HtcChrome.init();

    //only in dev
    if (location.href.indexOf('10.116.109.25') > 0) {
        $('#htc-site').append('<span style="color:red;">Width=' + $(window).width() + '</span>');
        $('#htc-site').append('<br><span style="color:red;">Height=' + $(window).height() + '</span>');
        $('#htc-site').append('<br><span style="color:red;">User agent=' + navigator.userAgent + '</span>');
        $('#htc-site').append('<br><span style="color:red;">Css Class=' + $('html').attr('class') + '</span>');
    }
});
